# ClinicHub Production Caddy Configuration
{$DOMAIN} {
    # Enable compression
    encode zstd gzip
    
    # Security headers
    header {
        # HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # XSS Protection
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        # CSP (adjust as needed)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src 'self' fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'"
        # Remove server info
        -Server
    }
    
    # API routes - preserve /api prefix for FastAPI
    route /api/* {
        reverse_proxy backend:8001 {
            # Health check
            health_uri /api/health
            health_interval 30s
            health_timeout 10s
            
            # Headers for backend
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }
    
    # Frontend static files
    root * /var/www/alpine-chub
    file_server
    
    # SPA routing - serve index.html for non-API routes
    try_files {path} /index.html
    
    # Logging
    log {
        output file /var/log/caddy/clinichub.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
        level INFO
    }
    
    # Rate limiting (optional)
    rate_limit {
        zone dynamic {
            key {remote_host}
            events 100
            window 1m
        }
    }
}